<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet.glify Integration Tests</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
        .test-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            margin: 5px;
            padding: 8px 16px;
            background: #007cbf;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #005a8b;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
        }
        .test-success { background: #d4edda; color: #155724; }
        .test-error { background: #f8d7da; color: #721c24; }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #e2e3e5;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="test-controls">
        <h3>Integration Tests</h3>
        <div class="status" id="status">Loading...</div>
        <button class="test-button" onclick="testBaseGlLayerConstruction()">
            Test BaseGlLayer Construction
        </button>
        <button class="test-button" onclick="testGlifyPointsCreation()">
            Test Glify Points Creation
        </button>
        <button class="test-button" onclick="testGlifyLinesCreation()">
            Test Glify Lines Creation
        </button>
        <button class="test-button" onclick="testGlifyShapesCreation()">
            Test Glify Shapes Creation
        </button>
        <div id="test-results"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Status updates
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        updateStatus('Loading Leaflet...');
        
        // Wait for Leaflet to load
        if (typeof L === 'undefined') {
            updateStatus('Error: Leaflet failed to load');
        } else {
            updateStatus('Leaflet loaded, initializing map...');
            
            // Initialize the map
            const map = L.map('map').setView([0, 0], 2);
            
            // Make map globally accessible for tests
            window.map = map;
            
            // Add a tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // Ensure map is properly initialized before proceeding
            map.whenReady(() => {
                // Force map to have valid center coordinates
                map.setView([0, 0], 2, { animate: false });
                map.invalidateSize();
                
                // Mock the map.project method to avoid real coordinate calculations
                map.project = function(latlng, zoom) {
                    return { x: 400, y: 300 }; 
                };
                
                // Additional delay to ensure coordinate system is fully ready
                setTimeout(() => {
                    updateStatus('Map initialized, loading glify...');
                    
                    // Load glify library
                    const script = document.createElement('script');
                    script.src = '/dist/glify-browser.js';
                    script.onload = function() {
                        updateStatus('Glify loaded, ready for testing!');
                        window.glifyLoaded = true;
                    };
                    script.onerror = function() {
                        updateStatus('Error: Failed to load glify library');
                    };
                    document.head.appendChild(script);
                }, 500);
            });
        }

        function showResult(message, isSuccess = true) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${isSuccess ? 'test-success' : 'test-error'}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (resultDiv.parentNode) {
                    resultDiv.parentNode.removeChild(resultDiv);
                }
            }, 5000);
        }

        function testBaseGlLayerConstruction() {
            if (!window.glifyLoaded) {
                showResult('Glify not loaded yet', false);
                return;
            }
            
            // Ensure map is ready
            if (!map.getCenter() || !map.getZoom()) {
                showResult('Map not ready yet', false);
                return;
            }
            
            try {
                // This test would fail without the fix because the constructor
                // calls map.project() which triggers getters that access undefined settings
                const glify = L.glify;
                
                // Try to create a layer without proper settings
                // This should fail without the fix because the constructor
                // calls map.project() which triggers getters that access undefined settings
                const points = glify.points({
                    map: map,
                    data: { 
                        type: "FeatureCollection", 
                        features: [] 
                    },
                    // Intentionally omit longitudeKey/latitudeKey to trigger the error
                    size: 5,
                    vertexShaderSource: " ",
                    fragmentShaderSource: " "
                });
                
                showResult('BaseGlLayer construction test passed - no errors occurred');
                return { success: true, points };
            } catch (error) {
                showResult(`BaseGlLayer construction test failed: ${error.message}`, false);
                return { success: false, error: error.message };
            }
        }

        function testGlifyPointsCreation() {
            if (!window.glifyLoaded) {
                showResult('Glify not loaded yet', false);
                return;
            }
            
            // Ensure map is ready
            if (!map.getCenter() || !map.getZoom()) {
                showResult('Map not ready yet', false);
                return;
            }
            
            try {
                const glify = L.glify;
                
                const points = glify.points({
                    map: map,
                    data: { 
                        type: "FeatureCollection", 
                        features: [] 
                    },
                    size: 5
                });
                
                showResult('Glify points creation test passed');
                return { success: true, points };
            } catch (error) {
                showResult(`Glify points creation test failed: ${error.message}`, false);
                return { success: false, error: error.message };
            }
        }

        function testGlifyLinesCreation() {
            if (!window.glifyLoaded) {
                showResult('Glify not loaded yet', false);
                return;
            }
            
            // Ensure map is ready
            if (!map.getCenter() || !map.getZoom()) {
                showResult('Map not ready yet', false);
                return;
            }
            
            try {
                const glify = L.glify;
                
                const lines = glify.lines({
                    map: map,
                    data: { 
                        type: "FeatureCollection", 
                        features: [] 
                    },
                    weight: 2
                });
                
                showResult('Glify lines creation test passed');
                return { success: true, lines };
            } catch (error) {
                showResult(`Glify lines creation test failed: ${error.message}`, false);
                return { success: false, error: error.message };
            }
        }

        function testGlifyShapesCreation() {
            if (!window.glifyLoaded) {
                showResult('Glify not loaded yet', false);
                return;
            }
            
            // Ensure map is ready
            if (!map.getCenter() || !map.getZoom()) {
                showResult('Map not ready yet', false);
                return;
            }
            
            try {
                const glify = L.glify;
                
                const shapes = glify.shapes({
                    map: map,
                    data: { 
                        type: "FeatureCollection", 
                        features: [] 
                    }
                });
                
                showResult('Glify shapes creation test passed');
                return { success: true, shapes };
            } catch (error) {
                showResult(`Glify shapes creation test failed: ${error.message}`, false);
                return { success: false, error: error.message };
            }
        }

        // Make test functions available globally for Playwright
        window.testBaseGlLayerConstruction = testBaseGlLayerConstruction;
        window.testGlifyPointsCreation = testGlifyPointsCreation;
        window.testGlifyLinesCreation = testGlifyLinesCreation;
        window.testGlifyShapesCreation = testGlifyShapesCreation;
    </script>
</body>
</html>
